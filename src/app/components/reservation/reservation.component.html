<div class="reservation-layout">
  <div class="reservation-content">
    <!--  booking restrictions warning if cart has items -->
    <div class="booking-restrictions" *ngIf="cartItems().length > 0">
      <mat-card>
        <mat-card-content>
          <div class="warning-message">
            <mat-icon>info</mat-icon>
            <span>
              Additional rooms must be:
              <ul>
                <li>For the same hotel and market</li>
                <li>Within your initial stay period</li>
              </ul>
            </span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-stepper #stepper linear>
      <!-- Search Step -->
      <mat-step [stepControl]="searchForm" label="Search">
        <mat-card class="search-form-card">
          <mat-card-header>
            <mat-card-title>Search Available Rooms</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <form
              [formGroup]="searchForm"
              (ngSubmit)="searchRooms()"
              class="search-form"
            >
              <!-- Your existing search form content -->
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Select Hotel</mat-label>
                  <mat-select
                    formControlName="hotelId"
                    (selectionChange)="onHotelChange()"
                  >
                    <mat-option
                      *ngFor="let hotel of hotels()"
                      [value]="hotel.id"
                    >
                      {{ hotel.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Market</mat-label>
                  <mat-select
                    formControlName="marketId"
                    (selectionChange)="onMarketChange()"
                  >
                    <mat-option
                      *ngFor="let market of availableMarkets()"
                      [value]="market.id"
                    >
                      {{ market.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="form-row dates">
                <mat-form-field appearance="outline">
                  <mat-label>Check-in Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="checkInPicker"
                    formControlName="checkIn"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="checkInPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #checkInPicker></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Check-out Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="checkOutPicker"
                    formControlName="checkOut"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="checkOutPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #checkOutPicker></mat-datepicker>
                </mat-form-field>
              </div>

              <div class="form-row occupancy">
                <mat-form-field appearance="outline">
                  <mat-label>Adults</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="adults"
                    min="1"
                  />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Children</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="children"
                    min="0"
                  />
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Infants</mat-label>
                  <input
                    matInput
                    type="number"
                    formControlName="infants"
                    min="0"
                  />
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="!searchForm.valid"
                >
                  Search Rooms
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>

        <!-- Room Selection -->
        <div
          class="available-rooms-container"
          *ngIf="filteredRooms().length > 0"
        >
          <h2>Available Rooms</h2>
          <div class="rooms-grid">
            <!-- Your existing room cards with updated styling -->
            <mat-card *ngFor="let room of filteredRooms()" class="room-card">
              <!-- Room Header -->
              <mat-card-header>
                <mat-card-title>{{ room.name }}</mat-card-title>
                <mat-card-subtitle>{{ room.category }}</mat-card-subtitle>
              </mat-card-header>

              <!-- Room Rate Section -->
              <div class="rate-section" *ngIf="getRoomRate(room) !== null">
                <div class="rate-amount">
                  <span class="currency"> {{ getMarketCurrency() }}</span>
                  <span class="amount">{{ getRoomRate(room) }}</span>
                  <span class="per-night">per night</span>
                </div>

                <!-- Meal Plan Badge -->
                <div class="meal-plan-badge">
                  <mat-icon>restaurant</mat-icon>
                  <span>{{
                    getMealPlanDisplayName(getBaseMealPlan(room))
                  }}</span>
                </div>
              </div>

              <!-- Show message if no rate is available -->
              <div class="no-rate-message" *ngIf="getRoomRate(room) === null">
                <mat-icon color="warn">warning</mat-icon>
                <span>Rate not available for selected criteria</span>
              </div>

              <!-- Room Details -->
              <mat-card-content>
                <div class="room-details">
                  <div class="occupancy-info">
                    <mat-icon>people</mat-icon>
                    <span
                      >Max Occupancy: {{ room.maxOccupancy.adults }} adults,
                      {{ room.maxOccupancy.children }} children</span
                    >
                  </div>

                  <div class="room-size">
                    <mat-icon>square_foot</mat-icon>
                    <span>{{ room.size }} m²</span>
                  </div>

                  <div class="amenities">
                    <h4>Key Amenities</h4>
                    <div class="amenities-grid">
                      <span
                        *ngFor="let amenity of room.amenities.slice(0, 4)"
                        class="amenity-tag"
                      >
                        {{ amenity }}
                      </span>
                    </div>
                  </div>
                </div>
              </mat-card-content>

              <mat-card-actions>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="selectRoom(room)"
                >
                  Select Room
                </button>
                <button mat-button (click)="viewDetails(room)">
                  View Details
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>

        <!-- No Results Message -->
        <mat-card
          class="no-results"
          *ngIf="searchForm.valid && filteredRooms().length === 0"
        >
          <mat-card-content>
            <mat-icon>info</mat-icon>
            <p>No rooms available for the selected criteria.</p>
          </mat-card-content>
        </mat-card>
      </mat-step>

      <!-- Meal Plan Selection Step -->
      <mat-step>
        <ng-template matStepLabel>Customize Stay</ng-template>

        <!-- Room Summary -->
        <div class="room-summary" *ngIf="currentStep()?.room as room">
          <div class="summary-header">
            <h3>{{ room.name }}</h3>
            <span class="base-rate">€{{ currentStep().baseRate }}</span>
          </div>

          <div class="meal-plan-base">
            <mat-icon>restaurant</mat-icon>
            <span>{{ getMealPlanDisplayName(getBaseMealPlan(room)) }}</span>
          </div>
        </div>

        <!-- Available Supplements -->
        <div
          class="supplements-section"
          *ngIf="currentStep()?.supplementRates as supplements"
        >
          <h4>Available Meal Plan Supplements</h4>

          <mat-selection-list
            #supplementList
            [multiple]="true"
            (selectionChange)="updateMealPlanSelection($event.options)"
          >
            <mat-list-option
              *ngFor="let supplement of supplements"
              [value]="supplement.type"
            >
              <div class="supplement-option">
                <div class="plan-info">
                  <span class="plan-name">{{ supplement.name }}</span>
                  <div class="rates">
                    <span>Adult: €{{ supplement.rates.adult }}</span>
                    <span>Child: €{{ supplement.rates.child }}</span>
                    <span>Infant: €{{ supplement.rates.infant }}</span>
                  </div>
                </div>
              </div>
            </mat-list-option>
          </mat-selection-list>
        </div>

        <!-- Total and Actions -->
        <div class="step-actions">
          <div class="total">
            <span>Total:</span>
            <span class="amount">€{{ currentStep().total }}</span>
          </div>

          <div class="action-buttons">
            <button mat-stroked-button (click)="stepper.previous()">
              Back
            </button>
            <button mat-raised-button color="primary" (click)="addToCart()">
              Add to Cart
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  </div>

  <!-- Cart Sidebar -->
  <div class="cart-sidebar" *ngIf="cartItems()?.length">
    <div class="cart-header">
      <h3>Your Cart</h3>
      <span class="item-count">{{ cartItems().length }} items</span>
    </div>

    <div class="cart-items">
      <div class="cart-item" *ngFor="let item of cartItems()">
        <div class="item-header">
          <span class="room-name">{{ item.room?.name }}</span>
          <span class="item-total">€{{ item.total }}</span>
        </div>
        <div class="item-details">
          <div class="meal-plans">
            <span class="base-plan">
              {{ getMealPlanDisplayName(getBaseMealPlan(item.room!)) }}
            </span>
            <span
              class="supplement"
              *ngFor="let plan of item.selectedMealPlans"
            >
              + {{ MEAL_PLAN_NAMES[plan] }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="cart-footer">
      <div class="cart-total">
        <span>Total:</span>
        <span class="amount">€{{ calculateCartTotal() }}</span>
      </div>

      <div class="cart-actions">
        <button mat-raised-button color="primary" (click)="proceedToCart()">
          Go to Cart
        </button>
        <button mat-stroked-button (click)="stepper.reset()">
          Add Another Room
        </button>
        <button mat-button color="warn" (click)="clearCart()">
          Clear Cart
        </button>
      </div>
    </div>
  </div>
</div>
