<form [formGroup]="offerForm" (ngSubmit)="onSubmit()" class="offer-form">
  <h2>{{ data.title }}</h2>
  <mat-stepper linear #stepper (selectionChange)="selectionChange($event)">
    <!-- Basic Information Step -->
    <mat-step [stepControl]="offerForm" label="Basic Information">
      <div class="step-content">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Code</mat-label>
            <input
              matInput
              formControlName="code"
              required
              uppercase
              placeholder="Enter a unique offer code (e.g., SUMMER24)"
            />
            <mat-icon matSuffix>code</mat-icon>
            <mat-error *ngIf="offerForm.get('code')?.invalid">
              {{ getFormErrorMessage(offerForm.get("code")) }}
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Name</mat-label>
            <input
              matInput
              formControlName="name"
              required
              placeholder="Enter a descriptive offer name"
            />
            <mat-error *ngIf="offerForm.get('name')?.invalid">
              {{ getFormErrorMessage(offerForm.get("name")) }}
            </mat-error>
          </mat-form-field>
        </div>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Type</mat-label>
          <mat-select formControlName="type" required>
            <mat-option value="combinable">Combinable</mat-option>
            <mat-option value="cumulative">Cumulative</mat-option>
          </mat-select>
          <mat-error *ngIf="offerForm.get('type')?.invalid">
            {{ getFormErrorMessage(offerForm.get("type")) }}
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            required
            rows="3"
            placeholder="Describe the offer details and benefits"
          ></textarea>
          <mat-error *ngIf="offerForm.get('description')?.invalid">
            {{ getFormErrorMessage(offerForm.get("description")) }}
          </mat-error>
        </mat-form-field>
      </div>
      <div class="step-actions">
        <button mat-button type="button" (click)="onCancel()">Cancel</button>
        <button mat-button matStepperNext type="button" (click)="onNextClick()">
          Next
        </button>
      </div>
    </mat-step>
    <!-- Discount Configuration Step -->
    <mat-step [stepControl]="offerForm" label="Discount Configuration">
      <div class="step-content">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Discount Type</mat-label>
          <mat-select formControlName="discountType" required>
            <mat-option value="percentage">Percentage</mat-option>
            <mat-option value="fixed">Fixed Amount</mat-option>
          </mat-select>
          <mat-error *ngIf="offerForm.get('discountType')?.invalid">
            {{ getFormErrorMessage(offerForm.get("discountType")) }}
          </mat-error>
        </mat-form-field>
        <h3><mat-icon>local_offer</mat-icon> Discount Values</h3>
        <div formArrayName="discountValues">
          <div
            *ngFor="let value of discountValues.controls; let i = index"
            [formGroupName]="i"
            class="discount-value-item"
          >
            <h4>Discount Value {{ i + 1 }}</h4>
            <div class="form-row">
              <!-- Booking Date Range -->
              <div formGroupName="bookingDateRange" class="date-range-section">
                <mat-form-field appearance="outline">
                  <mat-label>Booking Start Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="bookingStartPicker"
                    formControlName="start"
                    placeholder="dd/MM/yyyy"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="bookingStartPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #bookingStartPicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Booking End Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="bookingEndPicker"
                    formControlName="end"
                    placeholder="dd/MM/yyyy"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="bookingEndPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #bookingEndPicker></mat-datepicker>
                </mat-form-field>
              </div>
              <!-- Value Input -->
              <mat-form-field appearance="outline">
                <mat-label>Discount Value</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="value"
                  required
                  [min]="
                    offerForm.get('discountType')?.value === 'percentage'
                      ? 0
                      : 1
                  "
                  [max]="
                    offerForm.get('discountType')?.value === 'percentage'
                      ? 100
                      : null
                  "
                />
                <span matSuffix>{{
                  offerForm.get("discountType")?.value === "percentage"
                    ? "%"
                    : "â‚¬"
                }}</span>
                <mat-error *ngIf="value.get('value')?.hasError('required')">
                  Value is required
                </mat-error>
                <mat-error *ngIf="value.get('value')?.hasError('min')">
                  Must be greater than
                  {{
                    offerForm.get("discountType")?.value === "percentage"
                      ? "0"
                      : "1"
                  }}
                </mat-error>
                <mat-error *ngIf="value.get('value')?.hasError('max')">
                  Percentage cannot exceed 100
                </mat-error>
              </mat-form-field>
              <!-- Remove Button -->
              <button
                mat-icon-button
                color="warn"
                (click)="removeDiscountValue(i)"
                [disabled]="discountValues.length === 1"
                class="remove-button"
                matTooltip="Remove Discount Value"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
        <button mat-raised-button color="primary" (click)="addDiscountValue()">
          Add Discount Value
        </button>
      </div>
      <div class="step-actions">
        <button mat-button type="button" (click)="onCancel()">Cancel</button>
        <button
          mat-button
          matStepperPrevious
          type="button"
          (click)="onPreviousClick()"
        >
          Back
        </button>
        <button mat-button matStepperNext type="button" (click)="onNextClick()">
          Next
        </button>
      </div>
    </mat-step>
    <!-- Validity and Conditions Step -->
    <mat-step [stepControl]="offerForm" label="Validity & Conditions">
      <div class="step-content">
        <div class="minimum-nights">
          <mat-form-field appearance="outline">
            <mat-label>Minimum Nights</mat-label>
            <input
              matInput
              type="number"
              formControlName="minimumNights"
              min="1"
            />
            <mat-error *ngIf="offerForm.get('minimumNights')?.hasError('min')">
              Minimum nights must be at least 1
            </mat-error>
          </mat-form-field>
        </div>
        <div formGroupName="bookingWindow" class="date-range-section">
          <h3>
            <mat-icon>book_online</mat-icon>
            Booking Window
          </h3>
          <mat-form-field appearance="outline">
            <mat-label>Booking Start Date</mat-label>
            <input
              matInput
              [matDatepicker]="bookingWindowStartPicker"
              formControlName="start"
              placeholder="dd/MM/yyyy"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="bookingWindowStartPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #bookingWindowStartPicker></mat-datepicker>
            <mat-error
              *ngIf="offerForm.get('bookingWindow.start')?.hasError('required')"
            >
              Booking start date is required
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Booking End Date</mat-label>
            <input
              matInput
              [matDatepicker]="bookingWindowEndPicker"
              formControlName="end"
              placeholder="dd/MM/yyyy"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="bookingWindowEndPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #bookingWindowEndPicker></mat-datepicker>
            <mat-error
              *ngIf="offerForm.get('bookingWindow.end')?.hasError('required')"
            >
              Booking end date is required
            </mat-error>
          </mat-form-field>
        </div>
        <div formGroupName="travelDateRange" class="date-range-section">
          <h3>
            <mat-icon>date_range</mat-icon>
            Staying Dates
          </h3>
          <mat-form-field appearance="outline">
            <mat-label>Travel Start Date</mat-label>
            <input
              matInput
              [matDatepicker]="travelStartPicker"
              formControlName="start"
              placeholder="dd/MM/yyyy"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="travelStartPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #travelStartPicker></mat-datepicker>
            <mat-error
              *ngIf="
                offerForm.get('travelDateRange.start')?.hasError('required')
              "
            >
              Travel start date is required
            </mat-error>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Travel End Date</mat-label>
            <input
              matInput
              [matDatepicker]="travelEndPicker"
              formControlName="end"
              placeholder="dd/MM/yyyy"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="travelEndPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #travelEndPicker></mat-datepicker>
            <mat-error
              *ngIf="offerForm.get('travelDateRange.end')?.hasError('required')"
            >
              Travel end date is required
            </mat-error>
          </mat-form-field>
        </div>
        <div class="blackout-dates">
          <h3>
            <mat-icon>block</mat-icon>
            Blackout Dates
          </h3>
          <div formArrayName="blackoutDates">
            <div
              *ngFor="let date of blackoutDates.controls; let j = index"
              [formGroupName]="j"
              class="blackout-date-item"
            >
              <h4>Blackout Date {{ j + 1 }}</h4>
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Start Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="blackoutStartPicker"
                    formControlName="start"
                    placeholder="dd/MM/yyyy"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="blackoutStartPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #blackoutStartPicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>End Date</mat-label>
                  <input
                    matInput
                    [matDatepicker]="blackoutEndPicker"
                    formControlName="end"
                    placeholder="dd/MM/yyyy"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="blackoutEndPicker"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #blackoutEndPicker></mat-datepicker>
                </mat-form-field>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeBlackoutDate(j)"
                  class="remove-button"
                  matTooltip="Remove Blackout Date"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
          <button mat-raised-button color="primary" (click)="addBlackoutDate()">
            Add Blackout Date
          </button>
        </div>
        <div class="conditions">
          <h3>
            <mat-icon>rule</mat-icon>
            Conditions
          </h3>
          <div
            *ngFor="let condition of conditions.controls; let k = index"
            class="condition-item"
          >
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Condition {{ k + 1 }}</mat-label>
              <input matInput [formControl]="getFormControl(condition)" />
              <button
                mat-icon-button
                color="warn"
                (click)="removeCondition(k)"
                matSuffix
                class="remove-button"
                matTooltip="Remove Condition"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </mat-form-field>
          </div>
          <button mat-raised-button color="primary" (click)="addCondition()">
            Add Condition
          </button>
        </div>
      </div>
      <div class="step-actions">
        <button mat-button type="button" (click)="onCancel()">Cancel</button>
        <button
          mat-button
          matStepperPrevious
          type="button"
          (click)="onPreviousClick()"
        >
          Back
        </button>
        <button mat-button color="primary" type="submit">
          {{ isEdit ? "Save Changes" : "Create Offer" }}
        </button>
      </div>
    </mat-step>
  </mat-stepper>
</form>
