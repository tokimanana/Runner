<div class="market-config-container">
  <div class="market-groups-header">
    <h2>Market Regions Configuration</h2>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="openMarketGroupEditor()">
        <mat-icon>add</mat-icon>
        Add Region
      </button>
    </div>
  </div>

  <div class="market-groups-grid">
    <mat-card *ngFor="let group of marketGroups" class="market-group-card">
      <mat-card-header>
        <div class="market-group-title">
          <mat-icon class="region-icon">public</mat-icon>
          <mat-card-title>{{group.name}}</mat-card-title>
        </div>
        <div class="market-group-actions">
          <button mat-icon-button color="primary" (click)="openMarketGroupEditor(group)" 
                  matTooltip="Edit Region">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="primary" (click)="openMarketEditor(null, group)" 
                  matTooltip="Add new market">
            <mat-icon>add_location_alt</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="deleteMarketGroup(group)" 
                  [disabled]="group.markets.length > 0" 
                  matTooltip="Delete Region">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="markets-grid">
          <mat-card *ngFor="let marketId of group.markets" 
                    class="market-card" 
                    [class.has-rate]="hasRate(marketId)" 
                    [matTooltip]="hasRate(marketId) ? 'Ce marché a des rates configurés' : 'Aucun rate configuré pour ce marché'">
            <div class="market-header">
              <div class="market-title">
                <mat-icon class="market-icon">location_city</mat-icon>
                <div class="market-info">
                  <div class="market-name-row">
                    <span class="market-name">{{getMarketName(marketId)}}</span>
                    <mat-icon *ngIf="hasRate(marketId)" class="rate-indicator">check_circle</mat-icon>
                  </div>
                  <div class="status-indicator" 
                       [class.active]="isMarketActive(marketId)" 
                       (click)="toggleMarketStatus(marketId)" 
                       [matTooltip]="isMarketActive(marketId) ? 'Cliquer pour désactiver' : 'Cliquer pour activer'">
                    <span class="status-dot"></span>
                    <span class="status-text">{{ isMarketActive(marketId) ? 'Actif' : 'Inactif' }}</span>
                    <mat-icon class="status-toggle-icon">{{isMarketActive(marketId) ? 'toggle_on' : 'toggle_off'}}</mat-icon>
                  </div>
                </div>
              </div>
            </div>

            <mat-card-content>
              <div class="market-details">
                <div class="market-currency">
                  <span class="label">Currency:</span>
                  <mat-chip>{{getMarketCurrency(marketId)}}</mat-chip>
                </div>
                <p *ngIf="getMarketDescription(marketId)" class="market-description">
                  {{getMarketDescription(marketId)}}
                </p>
              </div>
            </mat-card-content>

            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="openMarketEditor(marketId, group)">
                <mat-icon>edit</mat-icon>
                <span>Edit</span>
              </button>
              <button mat-button color="warn" (click)="deleteMarket(marketId, group)">
                <mat-icon>delete</mat-icon>
                <span>Delete</span>
              </button>
            </mat-card-actions>
          </mat-card>
          
          <!-- Empty state when no markets -->
          <div *ngIf="group.markets.length === 0" class="empty-markets">
            <mat-icon>info</mat-icon>
            <p>No markets added to this region</p>
            <button mat-stroked-button color="primary" (click)="openMarketEditor(null, group)">
              <mat-icon>add</mat-icon>
              Add Market
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Market Group Editor Modal -->
  <app-modal [show]="showMarketGroupEditor" (close)="closeMarketGroupEditor()">
    <div class="modal-header">
      <h2 id="modalTitle">{{selectedMarketGroup ? 'Edit' : 'Add'}} Region</h2>
      <button mat-icon-button (click)="closeMarketGroupEditor()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="regionName">Region Name <span class="required">*</span></label>
        <input id="regionName" 
               type="text" 
               [(ngModel)]="newMarketGroup.name" 
               placeholder="e.g., Europe"
               (keydown.enter)="saveMarketGroup()" 
               (keydown.escape)="closeMarketGroupEditor()"
               required
               #firstInput>
      </div>

      <div class="form-group">
        <label for="defaultCurrency">Default Currency <span class="required">*</span></label>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Currency</mat-label>
          <mat-select id="defaultCurrency"
                  [(ngModel)]="newMarketGroup.defaultCurrency"
                  required
                  name="defaultCurrency">
            <mat-option *ngFor="let currency of currencySettings" 
                    [value]="currency.code"
                    [disabled]="!currency.isActive">
              {{currency.code}} ({{currency.symbol}})
            </mat-option>
          </mat-select>
          <mat-error *ngIf="!newMarketGroup.defaultCurrency">Currency is required</mat-error>
        </mat-form-field>
        <small class="form-text text-muted">Select the default currency for this region</small>
      </div>

      <div class="modal-actions">
        <button mat-button (click)="closeMarketGroupEditor()">Cancel</button>
        <button mat-raised-button 
                color="primary" 
                (click)="saveMarketGroup()"
                [disabled]="!newMarketGroup.name || !newMarketGroup.defaultCurrency">
          Save
        </button>
      </div>
    </div>
  </app-modal>

  <!-- Market Editor Modal -->
  <app-modal [show]="showMarketEditor" (close)="closeMarketEditor()">
    <div class="modal-header">
      <h2 id="modalTitle">{{selectedMarket ? 'Edit' : 'Add'}} Market</h2>
      <button mat-icon-button (click)="closeMarketEditor()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="marketName">Market Name</label>
        <input id="marketName" 
               type="text" 
               [(ngModel)]="newMarket.name" 
               placeholder="e.g., France"
               (keydown.enter)="saveMarket()" 
               (keydown.escape)="closeMarketEditor()"
               #firstInput>
      </div>

      <div class="form-group">
        <label for="marketDescription">Description</label>
        <textarea id="marketDescription" 
                  [(ngModel)]="newMarket.description" 
                  placeholder="Market description..."
                  rows="3"
                  (keydown.escape)="closeMarketEditor()">
        </textarea>
      </div>

      <div class="form-group">
        <label for="marketCurrency">Currency</label>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Currency</mat-label>
          <mat-select id="marketCurrency" 
                  [(ngModel)]="newMarket.currency"
                  required
                  name="currency">
            <mat-option *ngFor="let currency of currencySettings" 
                    [value]="currency.code"
                    [disabled]="!currency.isActive">
              {{currency.code}} ({{currency.symbol}})
            </mat-option>
          </mat-select>
          <mat-error *ngIf="!newMarket.currency">Currency is required</mat-error>
        </mat-form-field>
      </div>

      <div class="modal-actions">
        <button mat-button (click)="closeMarketEditor()">Cancel</button>
        <button mat-raised-button 
                color="primary" 
                (click)="saveMarket()"
                [disabled]="!newMarket.name || !newMarket.currency">
          Save
        </button>
      </div>
    </div>
  </app-modal>
</div>