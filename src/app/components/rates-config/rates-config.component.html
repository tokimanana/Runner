<div class="container">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-content">
      <div class="header-title">
        <i class="material-icons">payments</i>
        Rate Configuration
      </div>
      <div class="header-actions">
        <button mat-raised-button class="secondary-button" (click)="openAgeCategoryModal()">
          <i class="material-icons">people</i>
          Age Categories
        </button>
        <button mat-raised-button color="primary" (click)="openRateModal()">
          <i class="material-icons">add</i>
          Add New Rate
        </button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="success" class="success-message">
    <i class="material-icons">check_circle</i>
    {{ success }}
  </div>

  <!-- Error Message - Only show when modal is not open -->
  <div *ngIf="error && !showRateModal" class="error-message">
    <i class="material-icons">error</i>
    {{ error }}
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading rates...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Filters Section -->
    <div class="filter-section">
      <details>
        <summary>
          <i class="material-icons">filter_list</i>
          <span>Filters</span>
          <small>Filter rates by season, room type, and currency</small>
        </summary>

        <form [formGroup]="filterForm" class="filters-form">
          <div class="filter-field">
            <label>Season</label>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Season</mat-label>
              <mat-select formControlName="seasonId" class="form-select">
                <mat-option [value]="null">All Seasons</mat-option>
                <mat-option *ngFor="let season of seasons" [value]="season.id">
                  {{season.name}} ({{season.periods.length > 0 ? formatDateRange(season.periods[0].startDate, season.periods[0].endDate) : 'No periods'}})
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filter-field">
            <label>Room Type</label>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Room Type</mat-label>
              <mat-select formControlName="roomTypeId" class="form-select">
                <mat-option [value]="null">All Room Types</mat-option>
                <mat-option *ngFor="let room of rooms" [value]="room.id">
                  {{room.type}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filter-field">
            <label>Currency</label>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select Currency</mat-label>
              <mat-select formControlName="currency" class="form-select">
                <mat-option value="All">All Currencies</mat-option>
                <mat-option *ngFor="let currency of currencies" [value]="currency">
                  {{currency}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <button type="button" mat-button (click)="resetFilters()">
            <i class="material-icons">clear</i>
            Reset Filters
          </button>
        </form>
      </details>
    </div>

    <!-- Rates Display -->
    <div class="rates-container">
      <div class="rate-list">
        <div *ngFor="let rate of rateConfigurations" class="rate-item">
          <div class="rate-header">
            <!-- Get room type and season names from service -->
            <h3>{{getRoomName(rate.roomTypeId)}} - {{getSeasonName(rate.seasonId)}}</h3>
            <div class="actions">
              <button mat-icon-button (click)="editRate(rate)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="deleteRate(rate)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="rate-details">
            <div class="detail-row">
              <span class="label">Base Rate:</span>
              <span class="value">{{rate.baseRate | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Extra Adult:</span>
              <span class="value">{{rate.extraAdult | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Extra Child:</span>
              <span class="value">{{rate.extraChild | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Single Occupancy:</span>
              <span class="value">{{rate.singleOccupancy | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Region:</span>
              <span class="value">{{rate.region}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rate Modal -->
  <app-modal [show]="showRateModal" (close)="closeRateModal()">
    <div class="modal-header">
      <h2 id="modalTitle">{{ modalTitle }}</h2>
      <button mat-icon-button (click)="closeRateModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="rateModalForm" (ngSubmit)="saveRateModal(rateModalForm.value)">
      <!-- Modal Message -->
      <div *ngIf="modalMessage" [class]="modalError ? 'error-message' : 'success-message'">
        <i class="material-icons">{{ modalError ? 'error' : 'check_circle' }}</i>
        {{ modalMessage }}
      </div>
      
      <!-- Season Selection with Period Info -->
      <div class="form-field">
        <label for="seasonId">Season</label>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Select Season</mat-label>
          <mat-select id="seasonId" formControlName="seasonId" (selectionChange)="onSeasonChange($event)">
            <mat-option *ngFor="let season of seasons" [value]="season.id">
              {{ season.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="rateModalForm.get('seasonId')?.errors?.['required'] && rateModalForm.get('seasonId')?.touched">
            Season is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Period Selection -->
      <div class="form-field" *ngIf="selectedSeason">
        <label>Periods</label>
        <div class="periods-list">
          <div *ngFor="let period of selectedSeason.periods" class="period-item">
            <mat-checkbox color="primary" [formControlName]="'period_' + period.id">
              {{ formatDateRange(period.startDate, period.endDate) }}
              <span class="period-info" *ngIf="period.mlos">
                (Min. stay: {{ period.mlos }} nights)
              </span>
              <span class="period-badge" *ngIf="period.isBlackout">Blackout</span>
            </mat-checkbox>
          </div>
        </div>
        <small class="helper-text">Select specific periods or leave unchecked to apply to entire season</small>
      </div>

      <!-- Main Info -->
      <div class="form-row">
        <div class="form-group">
          <label for="roomType">Room Type</label>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Room Type</mat-label>
            <mat-select id="roomType" formControlName="roomTypeId">
              <mat-option *ngFor="let room of rooms" [value]="room.id">
                {{room.type}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="baseRate">Base Rate</label>
          <input type="number" id="baseRate" formControlName="baseRate" min="0" step="0.01">
          <div class="validation-error" *ngIf="rateModalForm.get('baseRate')?.errors?.['required'] && rateModalForm.get('baseRate')?.touched">
            Base rate is required
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button mat-button type="button" (click)="closeRateModal()">Cancel</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="!rateModalForm.valid">Save</button>
      </div>
    </form>
  </app-modal>

  <!-- Age Categories Modal -->
  <app-modal [show]="showAgeCategoryModal" (close)="closeAgeCategoryModal()">
    <div class="modal-header">
      <h2>Age Categories</h2>
      <button mat-icon-button (click)="closeAgeCategoryModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="age-categories-content">
      <div class="age-categories-list">
        <div *ngFor="let category of ageCategories" class="age-category-item">
          <div class="category-info">
            <span class="category-name">{{category.type}}</span>
            <span class="age-range">{{category.minAge}} - {{category.maxAge}} years</span>
          </div>
          <div class="category-actions">
            <button mat-icon-button color="primary" (click)="editCategory(category)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteCategory(category)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="age-category-form">
        <h3>{{editingCategory ? 'Edit' : 'Add'}} Age Category</h3>
        <form [formGroup]="categoryForm" (ngSubmit)="saveAgeCategory()">
          <div class="form-group">
            <label for="categoryType">Category Type</label>
            <input type="text" id="categoryType" formControlName="type">
          </div>

          <div class="form-group">
            <label for="categoryLabel">Category Label</label>
            <input type="text" id="categoryLabel" formControlName="label">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="minAge">Minimum Age</label>
              <input type="number" id="minAge" formControlName="minAge" min="0">
            </div>
            <div class="form-group">
              <label for="maxAge">Maximum Age</label>
              <input type="number" id="maxAge" formControlName="maxAge" min="0">
            </div>
          </div>

          <div class="form-group">
            <label for="defaultRate">Default Rate</label>
            <input type="number" id="defaultRate" formControlName="defaultRate" min="0" step="0.01">
          </div>

          <div class="modal-actions">
            <button mat-button type="button" (click)="cancelCategoryEdit()">Cancel</button>
            <button mat-raised-button color="primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </app-modal>
</div>