<div class="container">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-content">
      <div class="header-title">
        <i class="material-icons">payments</i>
        Rate Configuration
      </div>
      <div class="header-actions">
        <button mat-raised-button class="secondary-button" (click)="openAgeCategoryModal()">
          <i class="material-icons">people</i>
          Age Categories
        </button>
        <button mat-raised-button color="primary" (click)="openRateModal()">
          <i class="material-icons">add</i>
          Add New Rate
        </button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="success" class="success-message" role="alert">
    <i class="material-icons">check_circle</i>
    {{ success }}
  </div>

  <!-- Error Message - Only show when modal is not open -->
  <div *ngIf="error && !showRateModal" class="error-message" role="alert">
    <i class="material-icons">error</i>
    {{ error }}
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading rates...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Filters Section -->
    <div class="filter-section">
      <details>
        <summary>
          <i class="material-icons">filter_list</i>
          <span>Filters</span>
          <small>Filter rates by season, room type, and currency</small>
        </summary>

        <form [formGroup]="filterForm" class="filters-form" role="search">
          <div class="filter-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Season</mat-label>
              <mat-select id="seasonFilter" name="seasonFilter" formControlName="seasonId" class="form-select season-select" aria-label="Filter by season">
                <mat-option [value]="null">All Seasons</mat-option>
                <mat-option *ngFor="let season of seasons" [value]="season.id">
                  <span class="season-name">{{season.name}}</span>
                  <span class="season-period">
                    {{formatDateRange(
                      season.startDate || season.periods?.[0]?.startDate || '',
                      season.endDate || season.periods?.[0]?.endDate || ''
                    )}}
                  </span>
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filter-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Room Type</mat-label>
              <mat-select id="roomTypeFilter" name="roomTypeFilter" formControlName="roomTypeId" class="form-select" aria-label="Filter by room type">
                <mat-option [value]="null">All Room Types</mat-option>
                <mat-option *ngFor="let room of rooms" [value]="room.id">
                  {{room.type}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="filter-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Currency</mat-label>
              <mat-select id="currencyFilter" name="currencyFilter" formControlName="currency" class="form-select" aria-label="Filter by currency">
                <mat-option value="All">All Currencies</mat-option>
                <mat-option *ngFor="let currency of currencies" [value]="currency">
                  {{currency}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <button type="button" mat-button (click)="resetFilters()">
            <i class="material-icons">clear</i>
            Reset Filters
          </button>
        </form>
      </details>
    </div>

    <!-- Rates Display -->
    <div class="rates-container">
      <div class="rate-list">
        <div *ngFor="let rate of filteredRates" class="rate-item">
          <div class="rate-header">
            <!-- Get room type and season names from service -->
            <h3>{{getRoomName(rate.roomTypeId)}} - {{getSeasonName(rate.seasonId)}}</h3>
            <div class="actions">
              <button mat-icon-button (click)="editRate(rate)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="deleteRate(rate)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="rate-details">
            <div class="detail-row">
              <span class="label">Base Rate:</span>
              <span class="value">{{rate.baseRate | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Extra Adult:</span>
              <span class="value">{{rate.extraAdult | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Extra Child:</span>
              <span class="value">{{rate.extraChild | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Single Occupancy:</span>
              <span class="value">{{rate.singleOccupancy | number:'1.2-2'}} {{rate.currency}}</span>
            </div>
            <div class="detail-row">
              <span class="label">Region:</span>
              <span class="value">{{rate.region}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rate Modal -->
  <app-modal [show]="showRateModal" (close)="closeRateModal()">
    <div class="modal-header">
      <h2 id="modalTitle">{{ modalTitle }}</h2>
      <button mat-icon-button (click)="closeRateModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <form [formGroup]="rateModalForm" (ngSubmit)="saveRateModal(rateModalForm.value)" class="rate-form" role="form">
      <!-- Modal Message -->
      <div *ngIf="modalMessage" [class]="modalError ? 'error-message' : 'success-message'" role="alert">
        <i class="material-icons">{{ modalError ? 'error' : 'check_circle' }}</i>
        {{ modalMessage }}
      </div>
      
      <!-- Season Selection -->
      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Season</mat-label>
          <mat-select id="seasonSelect" name="seasonSelect" formControlName="seasonId" (selectionChange)="onSeasonChange($event)" required aria-required="true">
            <mat-option *ngFor="let season of seasons" [value]="season.id">
              {{ season.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="rateModalForm.get('seasonId')?.errors?.['required'] && rateModalForm.get('seasonId')?.touched">
            Season is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Period Selection -->
      <div class="form-field" *ngIf="selectedSeason">
        <fieldset>
          <legend>Periods</legend>
          <div class="periods-list">
            <div *ngFor="let period of selectedSeason.periods; let i = index" class="period-item">
              <mat-checkbox [id]="'period_' + period.id" 
                          [formControlName]="'period_' + period.id"
                          color="primary">
                <span class="period-label">{{ formatDateRange(period.startDate, period.endDate) }}</span>
                <span class="period-info" *ngIf="period.mlos">
                  (Min. stay: {{ period.mlos }} nights)
                </span>
                <span class="period-badge" *ngIf="period.isBlackout">Blackout</span>
              </mat-checkbox>
            </div>
          </div>
          <small class="helper-text" id="periodsHelp">Select specific periods or leave unchecked to apply to entire season</small>
        </fieldset>
      </div>

      <!-- Room Type Selection -->
      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Room Type</mat-label>
          <mat-select id="roomTypeSelect" name="roomTypeSelect" formControlName="roomTypeId" required aria-required="true">
            <mat-option *ngFor="let room of rooms" [value]="room.id">
              {{room.type}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="rateModalForm.get('roomTypeId')?.errors?.['required'] && rateModalForm.get('roomTypeId')?.touched">
            Room type is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Region Selection -->
      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Region</mat-label>
          <mat-select id="regionSelect" name="regionSelect" formControlName="region" required aria-required="true">
            <mat-option *ngFor="let group of marketGroups" [value]="group.region">
              {{group.region}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="rateModalForm.get('region')?.errors?.['required'] && rateModalForm.get('region')?.touched">
            Region is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Rate Fields -->
      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Base Rate</mat-label>
          <input matInput
                 type="number"
                 id="baseRate"
                 name="baseRate"
                 formControlName="baseRate"
                 min="0"
                 step="0.01"
                 required
                 aria-required="true">
          <mat-error *ngIf="rateModalForm.get('baseRate')?.errors?.['required'] && rateModalForm.get('baseRate')?.touched">
            Base rate is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Extra Adult Rate</mat-label>
          <input matInput
                 type="number"
                 id="extraAdult"
                 name="extraAdult"
                 formControlName="extraAdult"
                 min="0"
                 step="0.01"
                 required
                 aria-required="true">
          <mat-error *ngIf="rateModalForm.get('extraAdult')?.errors?.['required'] && rateModalForm.get('extraAdult')?.touched">
            Extra adult rate is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Extra Child Rate</mat-label>
          <input matInput
                 type="number"
                 id="extraChild"
                 name="extraChild"
                 formControlName="extraChild"
                 min="0"
                 step="0.01"
                 required
                 aria-required="true">
          <mat-error *ngIf="rateModalForm.get('extraChild')?.errors?.['required'] && rateModalForm.get('extraChild')?.touched">
            Extra child rate is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Single Occupancy Rate</mat-label>
          <input matInput
                 type="number"
                 id="singleOccupancy"
                 name="singleOccupancy"
                 formControlName="singleOccupancy"
                 min="0"
                 step="0.01">
        </mat-form-field>
      </div>

      <div class="modal-actions">
        <button mat-button type="button" (click)="closeRateModal()">Cancel</button>
        <button mat-raised-button color="primary" type="submit">Save</button>
      </div>
    </form>
  </app-modal>

  <!-- Age Categories Modal -->
  <app-modal [show]="showAgeCategoryModal" (close)="closeAgeCategoryModal()">
    <div class="modal-header">
      <h2>Age Categories</h2>
      <button mat-icon-button (click)="closeAgeCategoryModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  
    <div class="age-categories-content">
      <!-- Modal Message -->
      <div *ngIf="modalMessage" [class]="modalError ? 'error-message' : 'success-message'" role="alert">
        <i class="material-icons">{{ modalError ? 'error' : 'check_circle' }}</i>
        {{ modalMessage }}
      </div>
  
      <div class="age-categories-list">
        <div class="categories-header">
          <h3>Current Categories</h3>
          <button mat-raised-button color="primary" (click)="addNewCategory()" *ngIf="!showCategoryForm">
            <mat-icon>add</mat-icon>
            Add Category
          </button>
        </div>
        
        <div *ngFor="let category of ageCategories" class="age-category-item">
          <div class="category-info">
            <mat-icon>{{getCategoryIcon(category.type)}}</mat-icon>
            <div class="category-details">
              <span class="category-name">{{category.label}}</span>
              <span class="age-range">{{getAgeRange(category)}}</span>
            </div>
          </div>
          <div class="category-actions" *ngIf="!showCategoryForm">
            <button mat-icon-button color="primary" (click)="editCategory(category)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteCategory(category)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
  
      <!-- Age Category Form - Only show when adding/editing -->
      <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()" role="form">
        <h3>{{editingCategory ? 'Edit' : 'Add'}} Age Category</h3>
        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>Category Type</mat-label>
            <mat-select id="categoryType" name="categoryType" formControlName="type" required aria-required="true">
              <mat-option *ngFor="let type of categoryTypes" [value]="type.value">
                <mat-icon>{{type.icon}}</mat-icon>
                {{type.label}}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="categoryForm.get('type')?.errors?.['required'] && categoryForm.get('type')?.touched">
              Category type is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-group">
          <mat-form-field appearance="outline">
            <mat-label>Category Label</mat-label>
            <input matInput 
                   id="categoryLabel" 
                   name="categoryLabel" 
                   formControlName="label" 
                   placeholder="e.g., Adult, Child, Infant"
                   required
                   aria-required="true">
            <mat-error *ngIf="categoryForm.get('label')?.errors?.['required'] && categoryForm.get('label')?.touched">
              Category label is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <div class="form-group">
            <mat-form-field appearance="outline">
              <mat-label>Minimum Age</mat-label>
              <input matInput type="number" id="minAge" name="minAge" formControlName="minAge" min="0" max="100" required aria-required="true">
              <mat-error *ngIf="categoryForm.get('minAge')?.errors?.['required'] && categoryForm.get('minAge')?.touched">
                Minimum age is required
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-group">
            <mat-form-field appearance="outline">
              <mat-label>Maximum Age</mat-label>
              <input matInput type="number" id="maxAge" name="maxAge" formControlName="maxAge" min="0" max="100" required aria-required="true">
              <mat-error *ngIf="categoryForm.get('maxAge')?.errors?.['required'] && categoryForm.get('maxAge')?.touched">
                Maximum age is required
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <div class="modal-actions">
          <button mat-button type="button" (click)="cancelCategoryEdit()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="!categoryForm.valid">
            {{editingCategory ? 'Update' : 'Add'}} Category
          </button>
        </div>
      </form>
    </div>
  </app-modal>
</div>