<div class="container">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-content">
      <div class="header-title">
        <i class="material-icons">payments</i>
        Rate Configuration
      </div>
      <button mat-raised-button color="primary" (click)="openRateModal()">
        <i class="material-icons">add</i>
        Add New Rate
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading rates...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Filters Section -->
    <div class="filter-section">
      <details>
        <summary>
          <i class="material-icons">filter_list</i>
          <span>Filters</span>
          <small>Filter rates by season, room type, and currency</small>
        </summary>

        <form [formGroup]="filterForm" class="filters-form">
          <div class="filter-field">
            <label>Season</label>
            <select formControlName="seasonId">
              <option [value]="null">All Seasons</option>
              <option *ngFor="let season of seasons" [value]="season.id">
                {{season.name}} ({{formatDateRange(season.startDate, season.endDate)}})
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Room Type</label>
            <select formControlName="roomTypeId">
              <option [value]="null">All Room Types</option>
              <option *ngFor="let room of rooms" [value]="room.id">
                {{room.type}}
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Currency</label>
            <select formControlName="currency">
              <option value="All">All Currencies</option>
              <option *ngFor="let currency of currencies" [value]="currency">
                {{currency}}
              </option>
            </select>

            <button type="button" class="btn-secondary" (click)="resetFilters()">
              <i class="material-icons">clear</i>
              Reset Filters
            </button>
          </div>
        </form>
      </details>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-container">
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadInitialData()">Retry</button>
    </div>

    <!-- Rates Display -->
    <div class="rates-container">
      <div *ngFor="let group of getRatesGroupedByCurrency()" class="currency-group">
        <h3 class="currency-header">
          <i class="material-icons">payments</i>
          {{ group.currency }} Rates ({{ group.rates.length }})
        </h3>
        
        <div class="rate-cards">
          <div *ngFor="let rate of group.rates" class="rate-card">
            <div class="rate-header">
              <h3>{{rate.roomType.type}} - {{rate.season.name}}</h3>
              <div class="actions">
                <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Rate actions">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="editRate(rate)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit</span>
                  </button>
                  <button mat-menu-item (click)="duplicateRate(rate)">
                    <mat-icon>content_copy</mat-icon>
                    <span>Duplicate</span>
                  </button>
                  <button mat-menu-item (click)="deleteRate(rate)">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                </mat-menu>
              </div>
            </div>

            <div class="rate-details">
              <div class="detail-row">
                <span class="label">Base Rate:</span>
                <span class="value">{{rate.rates[0].baseRate | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Extra Adult:</span>
                <span class="value">{{rate.rates[0].supplements.extraAdult | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Extra Child:</span>
                <span class="value">{{rate.rates[0].supplements.extraChild | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Single Occupancy:</span>
                <span class="value">{{rate.rates[0].supplements.singleOccupancy | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="group.rates.length === 0" class="empty-state">
            <mat-icon>hotel</mat-icon>
            <p>No rates found. Add a new rate to get started.</p>
            <button mat-raised-button color="primary" (click)="openRateModal()">
              Add New Rate
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rate Modal -->
  <div class="modal" [class.show]="showRateModal" (click)="closeRateModal($event)">
    <div class="modal-content" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="modalTitle">
      <h2 id="modalTitle">{{ editingRate ? 'Edit' : 'Add' }} Rate</h2>
      
      <form [formGroup]="rateModalForm" (ngSubmit)="saveRateModal(rateModalForm.value)">
        <div class="form-group">
          <label>Season <span class="required">*</span></label>
          <select formControlName="seasonId">
            <option value="">Select a Season</option>
            <option *ngFor="let season of seasons" [value]="season.id">
              {{season.name}} ({{formatDateRange(season.startDate, season.endDate)}})
            </option>
          </select>
          <mat-error *ngIf="rateModalForm.get('seasonId')?.errors?.['required'] && rateModalForm.get('seasonId')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Room Type <span class="required">*</span></label>
          <select formControlName="roomTypeId">
            <option value="">Select a Room Type</option>
            <option *ngFor="let room of rooms" [value]="room.id">
              {{room.type}}
            </option>
          </select>
          <mat-error *ngIf="rateModalForm.get('roomTypeId')?.errors?.['required'] && rateModalForm.get('roomTypeId')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Region <span class="required">*</span></label>
          <select formControlName="region" (change)="onRegionChange($event)">
            <option value="">Select a Region</option>
            <option *ngFor="let group of marketGroups" [value]="group.code">
              {{group.name}}
            </option>
          </select>
          <mat-error *ngIf="rateModalForm.get('region')?.errors?.['required'] && rateModalForm.get('region')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Market <span class="required">*</span></label>
          <select formControlName="marketId" [attr.disabled]="!selectedRegion">
            <option value="">Select a Market</option>
            <option *ngFor="let market of filteredMarkets" [value]="market.id">
              {{market.name}}
            </option>
          </select>
          <mat-error *ngIf="rateModalForm.get('marketId')?.errors?.['required'] && rateModalForm.get('marketId')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Base Rate <span class="required">*</span></label>
          <input type="number" formControlName="baseRate" min="0">
          <mat-error *ngIf="rateModalForm.get('baseRate')?.errors?.['required'] && rateModalForm.get('baseRate')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
          <mat-error *ngIf="rateModalForm.get('baseRate')?.errors?.['min'] && rateModalForm.get('baseRate')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Extra Adult Rate <span class="required">*</span></label>
          <input type="number" formControlName="extraAdult" min="0">
          <mat-error *ngIf="rateModalForm.get('extraAdult')?.errors?.['required'] && rateModalForm.get('extraAdult')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
          <mat-error *ngIf="rateModalForm.get('extraAdult')?.errors?.['min'] && rateModalForm.get('extraAdult')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="form-group">
          <label>Extra Child <span class="required">*</span></label>
          <input type="number" formControlName="extraChild" min="0">
          <mat-error *ngIf="rateModalForm.get('extraChild')?.errors?.['required'] && rateModalForm.get('extraChild')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
          <mat-error *ngIf="rateModalForm.get('extraChild')?.errors?.['min'] && rateModalForm.get('extraChild')?.touched">
            <i class="material-icons">error</i>
          </mat-error>
        </div>

        <div class="modal-actions">
          <button mat-button type="button" (click)="closeRateModal()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="!rateModalForm.valid || isLoading">
            <span *ngIf="!isLoading">{{ editingRate ? 'Update' : 'Save' }}</span>
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Age Categories Modal -->
  <div class="modal" *ngIf="showAgeCategoryEditor && hotel">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configure Age Categories</h2>
        <button mat-button (click)="closeAgeCategoryEditor()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <div class="modal-body">
        <div class="categories-list">
          <div class="section-header">
            <h3>Age Categories</h3>
            <button mat-raised-button color="primary" (click)="showCategoryForm = true">
              <i class="material-icons">add</i>
              Add Category
            </button>
          </div>

          <div class="list">
            <div *ngFor="let category of hotel.ageCategories" class="list-item">
              <div class="category-item">
                <span class="category-type">{{category.type}}</span>
                <span class="age-range">{{getAgeRange(category)}}</span>
                <div class="category-actions">
                  <button mat-icon-button (click)="editCategory(category)">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="deleteCategory(category)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="category-form" *ngIf="showCategoryForm">
          <h3>{{editingCategory ? 'Edit' : 'Add'}} Category</h3>
          <div class="form-fields">
            <div class="form-field">
              <label>Category Type <span class="required">*</span></label>
              <input type="text" [(ngModel)]="newCategory.type" required>
            </div>

            <div class="form-field">
              <label>Minimum Age <span class="required">*</span></label>
              <input type="number" [(ngModel)]="newCategory.minAge" required min="0">
            </div>

            <div class="form-field">
              <label>Maximum Age <span class="required">*</span></label>
              <input type="number" [(ngModel)]="newCategory.maxAge" required min="0">
            </div>
          </div>

          <div class="form-actions">
            <button mat-button (click)="cancelCategoryEdit()">Cancel</button>
            <button mat-raised-button color="primary" (click)="saveCategory()">
              {{editingCategory ? 'Update' : 'Add'}} Category
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>