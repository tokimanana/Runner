<div class="rates-config-container">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-title">
      <i class="material-icons">payments</i>
      Rate Configuration
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading rates...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Filters Section -->
    <div class="filter-section">
      <details>
        <summary>
          <i class="material-icons">filter_list</i>
          <span>Filters</span>
          <small>Filter rates by season, room type, and currency</small>
        </summary>

        <form [formGroup]="filterForm" class="filters-form">
          <div class="filter-field">
            <label>Season</label>
            <select formControlName="seasonId">
              <option [value]="null">All Seasons</option>
              <option *ngFor="let season of seasons" [value]="season.id">
                {{season.name}} ({{formatDateRange(season.startDate, season.endDate)}})
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Room Type</label>
            <select formControlName="roomTypeId">
              <option [value]="null">All Room Types</option>
              <option *ngFor="let room of rooms" [value]="room.id">
                {{room.type}}
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Currency</label>
            <select formControlName="currency" (change)="onCurrencySelect($event)">
              <option [value]="null">All Currencies</option>
              <option *ngFor="let currency of currencies" [value]="currency">
                {{currency}}
              </option>
            </select>
          </div>

          <div class="filter-actions">
            <button class="btn-primary" (click)="applyFilters()">
              <i class="material-icons">filter_list</i>
              Apply Filters
            </button>
            <button class="btn-secondary" (click)="resetFilters()">
              <i class="material-icons">clear</i>
              Reset
            </button>
          </div>
        </form>
      </details>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-container">
      <p>{{ error }}</p>
      <button class="btn-primary" (click)="loadInitialData()">Retry</button>
    </div>

    <!-- Rates Display -->
    <div class="rates-container">
      <div *ngFor="let group of getRatesGroupedByCurrency()" class="currency-group">
        <h3 class="currency-header">
          <i class="material-icons">payments</i>
          {{ group.currency }} Rates ({{ group.rates.length }})
        </h3>
        
        <table class="rates-table">
          <thead>
            <tr>
              <th>Season</th>
              <th>Room Type</th>
              <th>Base Rate</th>
              <th>Extra Adult</th>
              <th>Extra Child</th>
              <th>Single Occupancy</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let rate of group.rates">
              <td>{{ rate.season.name }}</td>
              <td>{{ rate.roomType.type }}</td>
              <td>{{ rate.rates[0].baseRate | number:'1.2-2' }} {{ group.currency }}</td>
              <td>{{ rate.rates[0].supplements.extraAdult | number:'1.2-2' }} {{ group.currency }}</td>
              <td>{{ rate.rates[0].supplements.extraChild | number:'1.2-2' }} {{ group.currency }}</td>
              <td>{{ rate.rates[0].supplements.singleOccupancy | number:'1.2-2' }} {{ group.currency }}</td>
              <td class="action-buttons">
                <button class="btn-primary" (click)="editRate(rate)">
                  <i class="material-icons">edit</i>
                </button>
                <button class="btn-secondary" (click)="deleteRate(rate)">
                  <i class="material-icons">delete</i>
                </button>
                <button class="btn-accent" (click)="duplicateRate(rate)">
                  <i class="material-icons">content_copy</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No rates found -->
      <div *ngIf="getRatesGroupedByCurrency().length === 0" class="no-rates-container">
        <p>No rates found for the selected filters.</p>
        <button class="btn-primary" (click)="resetFilters()">Reset Filters</button>
      </div>
    </div>
  </div>

  <!-- Rate Editor Modal -->
  <div *ngIf="showRateEditor" class="rate-editor">
    <div class="toolbar">
      <span>{{ editingRate ? 'Edit Rate' : 'Add New Rate' }}</span>
    </div>

    <div class="stepper">
      <!-- Basic Info Step -->
      <div class="step">
        <div class="step-label">Basic Information</div>
        <div class="step-content">
          <form [formGroup]="basicInfoForm" class="rate-form">
            <div class="form-row">
              <div class="form-field">
                <label>Season</label>
                <select formControlName="season">
                  <option *ngFor="let season of seasons" [value]="season.id">
                    {{season.name}}
                  </option>
                </select>
              </div>

              <div class="form-field">
                <label>Room Type</label>
                <select formControlName="roomType">
                  <option *ngFor="let room of rooms" [value]="room.id">
                    {{room.type}}
                  </option>
                </select>
              </div>
            </div>
            <div class="step-actions">
              <button class="btn-primary" matStepperNext>Next</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Category Rates Step -->
      <div class="step">
        <div class="step-label">Category Rates</div>
        <div class="step-content">
          <form [formGroup]="categoryRatesForm">
            <div class="category-rates-grid">
              <div *ngFor="let category of categories" class="category-rate-card animate-in">
                <div class="form-field">
                  <label>{{category.type | titlecase}} ({{category.minAge}}-{{category.maxAge}})</label>
                  <input type="number" [formControlName]="category.id.toString()">
                  <div class="error-message" *ngIf="categoryRatesForm.get(category.id.toString())?.hasError('required')">
                    Rate is required
                  </div>
                </div>
              </div>
            </div>
            <div class="step-actions">
              <button class="btn-secondary" matStepperPrevious>Back</button>
              <button class="btn-primary" matStepperNext>Next</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Meal Plans Step -->
      <div class="step">
        <div class="step-label">Meal Plans</div>
        <div class="step-content">
          <form [formGroup]="mealPlansForm">
            <div class="meal-plans-container">
              <div class="form-field">
                <label>Meal Plans</label>
                <div class="chip-list">
                  <div *ngFor="let plan of mealPlans" class="chip">
                    {{plan}}
                  </div>
                </div>
              </div>
            </div>
            <div class="step-actions">
              <button class="btn-secondary" matStepperPrevious>Back</button>
              <button class="btn-primary" matStepperNext>Next</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Review Step -->
      <div class="step">
        <div class="step-label">Review</div>
        <div class="step-content">
          <div class="rate-review">
            <h3>Review Rate Configuration</h3>
            <div class="rate-info-grid">
              <div class="rate-info-item">
                <span class="rate-label">Season</span>
                <span class="rate-value">{{basicInfoForm.get('season')?.value}}</span>
              </div>
              <div class="rate-info-item">
                <span class="rate-label">Room Type</span>
                <span class="rate-value">{{basicInfoForm.get('roomType')?.value}}</span>
              </div>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn-secondary" matStepperPrevious>Back</button>
            <button class="btn-primary" (click)="saveRate()">Save Rate</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Age Categories Modal -->
  <div class="modal" *ngIf="showAgeCategoryEditor && hotel">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configure Age Categories</h2>
        <button class="btn-secondary" (click)="closeAgeCategoryEditor()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <div class="modal-body">
        <div class="categories-list">
          <div class="section-header">
            <h3>Age Categories</h3>
            <button class="btn-primary" (click)="showCategoryForm = true">
              <i class="material-icons">add</i>
              Add Category
            </button>
          </div>

          <div class="list">
            <div *ngFor="let category of hotel.ageCategories" class="list-item">
              <div class="category-item">
                <span class="category-type">{{category.type}}</span>
                <span class="age-range">{{getAgeRange(category)}}</span>
                <div class="category-actions">
                  <button class="btn-primary" (click)="editCategory(category)">
                    <i class="material-icons">edit</i>
                  </button>
                  <button class="btn-secondary" (click)="deleteCategory(category)">
                    <i class="material-icons">delete</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="category-form" *ngIf="showCategoryForm">
          <h3>{{editingCategory ? 'Edit' : 'Add'}} Category</h3>
          <div class="form-fields">
            <div class="form-field">
              <label>Category Type</label>
              <input type="text" [(ngModel)]="newCategory.type" required>
            </div>

            <div class="form-field">
              <label>Minimum Age</label>
              <input type="number" [(ngModel)]="newCategory.minAge" required min="0">
            </div>

            <div class="form-field">
              <label>Maximum Age</label>
              <input type="number" [(ngModel)]="newCategory.maxAge" required min="0">
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-secondary" (click)="cancelCategoryEdit()">Cancel</button>
            <button class="btn-primary" (click)="saveCategory()">
              {{editingCategory ? 'Update' : 'Add'}} Category
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>