<div class="container">
  <!-- Header Card -->
  <div class="header-card">
    <div class="header-content">
      <div class="header-title">
        <i class="material-icons">payments</i>
        Rate Configuration
      </div>
      <button mat-raised-button color="primary" (click)="openRateModal()">
        <i class="material-icons">add</i>
        Add New Rate
      </button>
    </div>
  </div>

  <!-- Success Message -->
  <div *ngIf="success" class="success-message">
    <i class="material-icons">check_circle</i>
    {{ success }}
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message">
    <i class="material-icons">error</i>
    {{ error }}
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading rates...</p>
  </div>

  <div *ngIf="!isLoading">
    <!-- Filters Section -->
    <div class="filter-section">
      <details>
        <summary>
          <i class="material-icons">filter_list</i>
          <span>Filters</span>
          <small>Filter rates by season, room type, and currency</small>
        </summary>

        <form [formGroup]="filterForm" class="filters-form">
          <div class="filter-field">
            <label>Season</label>
            <select formControlName="seasonId">
              <option [value]="null">All Seasons</option>
              <option *ngFor="let season of seasons" [value]="season.id">
                {{season.name}} ({{formatDateRange(season.startDate, season.endDate)}})
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Room Type</label>
            <select formControlName="roomTypeId">
              <option [value]="null">All Room Types</option>
              <option *ngFor="let room of rooms" [value]="room.id">
                {{room.type}}
              </option>
            </select>
          </div>

          <div class="filter-field">
            <label>Currency</label>
            <select formControlName="currency">
              <option value="All">All Currencies</option>
              <option *ngFor="let currency of currencies" [value]="currency">
                {{currency}}
              </option>
            </select>
          </div>

          <button type="button" mat-button (click)="resetFilters()">
            <i class="material-icons">clear</i>
            Reset Filters
          </button>
        </form>
      </details>
    </div>

    <!-- Rates Display -->
    <div class="rates-container">
      <div *ngFor="let group of getRatesGroupedByCurrency()" class="currency-group">
        <h3 class="currency-header">
          <i class="material-icons">payments</i>
          {{ group.currency }} Rates ({{ group.rates.length }})
        </h3>
        
        <div class="rate-cards">
          <div *ngFor="let rate of group.rates; let i = index" class="rate-card">
            <div class="rate-header">
              <h3>{{rate.roomType.type}} - {{rate.season.name}}</h3>
              <div class="actions">
                <button type="button" mat-icon-button (click)="editRate(rate)" class="action-button edit-button" title="Edit Rate">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" mat-icon-button (click)="duplicateRate(rate)" class="action-button duplicate-button" title="Duplicate Rate">
                  <mat-icon>content_copy</mat-icon>
                </button>
                <button type="button" mat-icon-button (click)="deleteRate(rate)" class="action-button delete-button" title="Delete Rate">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="rate-details">
              <div class="detail-row">
                <span class="label">Base Rate:</span>
                <span class="value">{{rate.rates[0].baseRate | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Extra Adult:</span>
                <span class="value">{{rate.rates[0].supplements.extraAdult | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Extra Child:</span>
                <span class="value">{{rate.rates[0].supplements.extraChild | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
              <div class="detail-row">
                <span class="label">Single Occupancy:</span>
                <span class="value">{{rate.rates[0].supplements.singleOccupancy | number:'1.2-2'}} {{ group.currency }}</span>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="group.rates.length === 0" class="empty-state">
            <mat-icon>hotel</mat-icon>
            <p>No rates found for {{ group.currency }}. Add a new rate to get started.</p>
            <button mat-raised-button color="primary" (click)="openRateModal()">
              Add New Rate
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rate Modal -->
  <div class="modal" [class.show]="showRateModal" (click)="closeRateModal($event)">
    <div class="modal-content" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="modalTitle">
      <h2 id="modalTitle">{{ modalTitle }}</h2>
      
      <!-- Message Area -->
      <div class="message-area" *ngIf="modalMessage">
        <div [class]="'alert ' + (modalError ? 'alert-error' : 'alert-info')">
          <i class="material-icons">{{ modalError ? 'error' : 'info' }}</i>
          <span>{{ modalMessage }}</span>
        </div>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="rateModalForm" (ngSubmit)="saveRateModal(rateModalForm.value)">
          <!-- Main Info -->
          <div class="form-row">
            <div class="form-group">
              <label for="season">Season</label>
              <select id="season" formControlName="seasonId">
                <option [ngValue]="null">Select Season</option>
                <option *ngFor="let season of seasons" [value]="season.id">
                  {{season.name}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="roomType">Room Type</label>
              <select id="roomType" formControlName="roomTypeId">
                <option [ngValue]="null">Select Room Type</option>
                <option *ngFor="let room of rooms" [value]="room.id">
                  {{room.type}}
                </option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="region">Region</label>
            <select id="region" formControlName="region">
              <option [ngValue]="null">Select Region</option>
              <option *ngFor="let group of marketGroups" [value]="group.code">
                {{group.name}} ({{group.markets.length}} markets)
              </option>
            </select>
            <small class="help-text">Rate will be created for all markets in the selected region</small>
          </div>

          <!-- Rate Info -->
          <div class="form-row">
            <div class="form-group">
              <label for="baseRate">Base Rate</label>
              <input type="number" id="baseRate" formControlName="baseRate" min="0" step="0.01">
            </div>

            <div class="form-group">
              <label for="singleOccupancy">Single Occupancy (Optional)</label>
              <input type="number" id="singleOccupancy" formControlName="singleOccupancy" min="0" step="0.01">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="extraAdult">Extra Adult (Optional)</label>
              <input type="number" id="extraAdult" formControlName="extraAdult" min="0" step="0.01">
            </div>

            <div class="form-group">
              <label for="extraChild">Extra Child (Optional)</label>
              <input type="number" id="extraChild" formControlName="extraChild" min="0" step="0.01">
            </div>
          </div>
        </form>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeRateModal($event)">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="!rateModalForm.valid" (click)="saveRateModal(rateModalForm.value)">
          {{ editingRate ? 'Update' : 'Create' }} Rate
        </button>
      </div>
    </div>
  </div>

  <!-- Age Categories Modal -->
  <div class="modal" *ngIf="showAgeCategoryEditor && hotel">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configure Age Categories</h2>
        <button mat-button (click)="closeAgeCategoryEditor()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <div class="modal-body">
        <div class="categories-list">
          <div class="section-header">
            <h3>Age Categories</h3>
            <button mat-raised-button color="primary" (click)="showCategoryForm = true">
              <i class="material-icons">add</i>
              Add Category
            </button>
          </div>

          <div class="list">
            <div *ngFor="let category of hotel.ageCategories" class="list-item">
              <div class="category-item">
                <span class="category-type">{{category.type}}</span>
                <span class="age-range">{{getAgeRange(category)}}</span>
                <div class="category-actions">
                  <button mat-icon-button (click)="editCategory(category)">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="deleteCategory(category)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="category-form" *ngIf="showCategoryForm">
          <h3>{{editingCategory ? 'Edit' : 'Add'}} Category</h3>
          <div class="form-fields">
            <div class="form-field">
              <label>Category Type <span class="required">*</span></label>
              <input type="text" [(ngModel)]="newCategory.type" required>
            </div>

            <div class="form-field">
              <label>Minimum Age <span class="required">*</span></label>
              <input type="number" [(ngModel)]="newCategory.minAge" required min="0">
            </div>

            <div class="form-field">
              <label>Maximum Age <span class="required">*</span></label>
              <input type="number" [(ngModel)]="newCategory.maxAge" required min="0">
            </div>
          </div>

          <div class="form-actions">
            <button mat-button (click)="cancelCategoryEdit()">Cancel</button>
            <button mat-raised-button color="primary" (click)="saveCategory()">
              {{editingCategory ? 'Update' : 'Add'}} Category
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>