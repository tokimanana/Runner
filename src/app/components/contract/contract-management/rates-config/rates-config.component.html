<form [formGroup]="ratesForm">
  <div formArrayName="roomTypes">
    <div *ngFor="let roomType of getRoomTypesFormArray().controls; let roomTypeIndex = index" [formGroupName]="roomTypeIndex" class="room-type-rates">
      <h3>{{ getRoomTypeName(roomType.value.roomTypeId) }}</h3>

      <!-- Iterate over periods for each room type -->
      <div formArrayName="periods">
        <div *ngFor="let period of getPeriodsFormArray(roomTypeIndex).controls; let periodIndex = index" [formGroupName]="periodIndex">
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ getPeriodName(period.value.periodId) }}
              </mat-panel-title>
            </mat-expansion-panel-header>

            <mat-button-toggle-group [formControl]="getRateTypeControl(roomTypeIndex, periodIndex)!" class="rate-type-toggle">
              <mat-button-toggle value="per_pax">Per Person</mat-button-toggle>
              <mat-button-toggle value="per_villa">Per Villa</mat-button-toggle>
            </mat-button-toggle-group>

            <!-- Rates Configuration -->
            <div [ngSwitch]="getPeriodControl(roomTypeIndex, periodIndex).get('rateType')?.value">
              <!-- Per Villa Rates -->
              <div *ngSwitchCase="'per_villa'" [formGroup]="getPerVillaRatesControl(roomTypeIndex, periodIndex)" class="per-villa-rates">
                <h4>Per Villa Rates</h4>
                <div class="meal-plan-rates">
                  <mat-form-field *ngFor="let mealPlan of availableMealPlans">
                    <mat-label>{{ mealPlan.name }}</mat-label>
                    <input matInput type="number" [formControlName]="mealPlan.id" min="0">
                  </mat-form-field>
                </div>
              </div>

              <!-- Per Person Rates -->
              <div *ngSwitchCase="'per_pax'" [formGroup]="getPerPaxRatesFormGroup(roomTypeIndex, periodIndex)" class="per-pax-rates">
                <!-- Rates for each meal plan -->
                <div *ngFor="let mealPlan of availableMealPlans">
                  <div [formGroupName]="mealPlan.id" class="meal-plan-section">
                    <h4>{{ mealPlan.name }}</h4>

                    <!-- Adult Rates -->
                    <div formGroupName="adultRates">
                      <h5>Adult Rates</h5>
                      <div class="occupancy-rates">
                        <mat-form-field *ngFor="let control of getAdultRatesControls(roomTypeIndex, periodIndex) | keyvalue">
                          <mat-label>{{ getOccupancyLabel(control.key) }}</mat-label>
                          <input matInput type="number" [formControlName]="control.key" min="0">
                        </mat-form-field>
                      </div>
                    </div>

                    <!-- Teen Rates -->
                    <div formGroupName="teenRates">
                      <h5>Teen Rates</h5>
                      <div class="occupancy-rates">
                        <mat-form-field *ngFor="let control of getTeenRatesControls(roomTypeIndex, periodIndex) | keyvalue">
                          <mat-label>{{ getOccupancyLabel(control.key) }}</mat-label>
                          <input matInput type="number" [formControlName]="control.key" min="0">
                        </mat-form-field>
                      </div>
                    </div>

                    <!-- Child Rates -->
                    <div formGroupName="childRates">
                      <h5>Child Rates</h5>
                      <div class="occupancy-rates">
                        <mat-form-field *ngFor="let control of getChildRatesControls(roomTypeIndex, periodIndex) | keyvalue">
                          <mat-label>{{ getOccupancyLabel(control.key) }}</mat-label>
                          <input matInput type="number" [formControlName]="control.key" min="0">
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="!ratesForm.valid">
      Save Rates
    </button>
  </div>
</form>